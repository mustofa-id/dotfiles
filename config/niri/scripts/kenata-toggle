#!/usr/bin/env bash
set -euo pipefail

# -----------------------------------------------------------------------------
# Kanata toggle script (Wayland-safe, idempotent, race-free)
#
# This script avoids PID files on purpose because process detection + 
# foreground execution + kernel locks produce a toggle that is crash-safe, 
# Wayland-safe, and always reflects the real state.
#
# - We do NOT use a .pid file.
#   Kanata daemonizes by default and may fork/exit during startup.
#   A saved PID often belongs to a short-lived parent process, leading
#   to stale PID files and incorrect ON/OFF state.
#
# - Instead, we detect the *real state* by checking whether a kanata
#   process is actually running (pgrep).
#   Processes are the source of truth.
#
# - We run kanata with --foreground so it does not double-fork.
#   This gives predictable lifecycle behavior under Wayland.
#
# - We use flock(1) to prevent race conditions caused by key repeat
#   or multiple rapid invocations from compositor keybinds.
#
# BENEFITS OVER PID FILE APPROACH:
# - Idempotent: state always reflects reality
# - Crash-safe: no stale files after crashes or kill -9
# - Reboot-safe: nothing to clean up
# - Wayland-correct: no session or environment assumptions
# - Safe to bind to keys and mash repeatedly
# -----------------------------------------------------------------------------

KANATA_BIN="/usr/bin/kanata"
CONFIG="$HOME/.config/kanata/config.kbd"
LOCKFILE="$HOME/.cache/kanata.lock"

notify() {
    # Wayland-friendly OSD notification
    if command -v swayosd-client >/dev/null 2>&1; then
        swayosd-client --custom-message "$1"
	else
		notify-send "Kanata" "$1" -t 1500
    fi
}

is_running() {
    # Detect real kanata state.
    # This avoids stale PID files and reflects crashes or manual kills.
    pgrep -x kanata >/dev/null 2>&1
}

# -----------------------------------------------------------------------------
# Locking
#
# Prevents multiple instances of this script from running simultaneously.
# This can happen due to key repeat or rapid hotkey presses.
#
# flock locks are kernel-managed and are automatically released on:
# - script exit
# - crash
# - logout
# - reboot
#
# The lock file may remain, but it will never be "stuck".
# -----------------------------------------------------------------------------
exec 9>"$LOCKFILE" || exit 1
flock -n 9 || exit 0

# -----------------------------------------------------------------------------
# Toggle logic (idempotent)
# -----------------------------------------------------------------------------
if is_running; then
    # If kanata is running, turn it OFF
    pkill -x kanata
    notify "Alt → Meta: OFF"
else
    # If kanata is not running, try to turn it ON
    "$KANATA_BIN" -c "$CONFIG" --foreground >/dev/null 2>&1 &
    sleep 0.1

    # Verify kanata actually started (e.g. uinput permissions)
    if is_running; then
        notify "Alt → Meta: ON"
    else
        notify "Alt → Meta: FAILED (check uinput permissions)"
        exit 1
    fi
fi
